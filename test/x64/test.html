<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>MP3 æ’­æ”¾å™¨ + WebSocket åŒæ­¥</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    label { display: block; margin-top: 10px; }
    input[type="text"] { width: 500px; }
    button { margin: 5px; }
  </style>
</head>
<body>
  <h2>ğŸµ MP3 æ’­æ”¾å™¨ + WebSocket åŒæ­¥</h2>

  <label>MP3æ–‡ä»¶è·¯å¾„:
    <input type="text" id="mp3Path" placeholder="http://localhost/test.mp3" value="I:\éŸ³ä¹\Marian Hill - Got It.mp3">
  </label>

  <label>æ­Œè¯æ–‡ä»¶è·¯å¾„:
    <input type="text" id="lyricPath" placeholder="http://localhost/test.lrc" value="J:\cahce\kugou\Lyric\Marian Hill - Got It-7ac6d1947f09459f4ed321d9992a2f53-167848927-00000000.krc">
  </label>

  <div style="margin-top: 10px;">
    <button id="playButton" onclick="togglePlay()">â–¶ æ’­æ”¾</button>
    <button onclick="seek(-5)">âª å¿«é€€5ç§’</button>
    <button onclick="seek(5)">â© å¿«è¿›5ç§’</button>
  </div>

  <p>å½“å‰æ’­æ”¾æ—¶é—´ï¼š<span id="timeDisplay">0.00s</span></p>

  <audio id="audio" preload="auto"></audio>
  <pre id="wsState" style="white-space: pre-wrap; background: #f0f0f0; padding: 10px; height: 50px; overflow-y: auto; font-size: 24px;"></pre>
  <div>
    <h3>æ”¶åˆ°çš„ WS æ¶ˆæ¯ï¼š</h3>
    <pre id="wsMessages" style="white-space: pre-wrap; background: #f0f0f0; padding: 10px; height: 100px; overflow-y: auto; font-size: 24px;"></pre>
  </div>
  <script>
    const audio = document.getElementById('audio');
    const mp3PathInput = document.getElementById('mp3Path');
    const timeDisplay = document.getElementById('timeDisplay');
    const playButton = document.getElementById('playButton');

    let ws = null;
    let timer = null;
    let isPlaying = false;
    let hasLoaded = false;

    function connectWebSocket() {
      ws = new WebSocket("ws://localhost:6520");
      const wsMessages = document.getElementById('wsMessages');
      const wsState = document.getElementById('wsState');
      let reconnectInterval = 1000; // 1ç§’åé‡è¿
      
      ws.onopen = () => {
        wsState.textContent = "âœ… WebSocket å·²è¿æ¥";
      };
      ws.onmessage = e => {
        wsMessages.textContent = event.data;
      };
      ws.onerror = e => {
        wsState.textContent = "âŒ WebSocket é”™è¯¯:" + e.message;
      };

      ws.onclose = () => {
        wsState.textContent = "ğŸ”Œ WebSocket å·²æ–­å¼€, 1ç§’åå°è¯•é‡è¿";
        setTimeout(connectWebSocket, reconnectInterval);
      };
    }

    const lyricPathInput = document.getElementById('lyricPath');

    function togglePlay() {
      if (!hasLoaded) {
        const url = mp3PathInput.value.trim();
        if (!url) {
          alert("è¯·è¾“å…¥ MP3 è·¯å¾„ï¼");
          return;
        }
        audio.src = url;
        hasLoaded = true;
      }

      if (isPlaying) {
        audio.pause();
        clearInterval(timer);
        playButton.textContent = "â–¶ æ’­æ”¾";
        isPlaying = false;
      } else {
        audio.play().then(() => {
          // æ’­æ”¾æˆåŠŸï¼Œå‘é€æ­Œè¯åŠ è½½æ¶ˆæ¯
          const lyricFile = lyricPathInput.value.trim();

          if (ws && ws.readyState === WebSocket.OPEN && lyricFile) {
            ws.send(JSON.stringify({
              method: "lyric_desktop_load_lyric",
              params: {
                file: lyricFile,
                lyric: "krc"
              }
            }));
          }
        }).catch(e => alert("æ’­æ”¾å¤±è´¥ï¼š" + e));

        timer = setInterval(() => {
          const time = Math.floor(audio.currentTime * 1000);
          timeDisplay.textContent = time + "ms";

          if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({
              method: "lyric_desktop_update",
              params: {
                time: time
              }
            }));
          }
        }, 10);

        playButton.textContent = "â¸ æš‚åœ";
        isPlaying = true;
      }
    }

    function seek(offset) {
      audio.currentTime += offset;
    }

    // æ’­æ”¾ç»“æŸåé‡ç½®æŒ‰é’®
    audio.addEventListener('ended', () => {
      clearInterval(timer);
      playButton.textContent = "â–¶ æ’­æ”¾";
      isPlaying = false;
    });

    window.onload = connectWebSocket;
  </script>
</body>
</html>
